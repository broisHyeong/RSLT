name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Check jq installation on GitHub Actions
        run: |
          jq --version

      # ğŸ”¥ DEBUG: GitHub Secretsì˜ FIREBASE_SERVICE_ACCOUNT ë‚´ìš© í™•ì¸ (ë‚˜ì¤‘ì— ì‚­ì œí•  ê²ƒ)
     # - name: Debug Secrets (REMOVE AFTER DEBUGGING)
      #  run: |
       #   echo "FIREBASE_SERVICE_ACCOUNT CONTENT:"
        #  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}"

      # Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ JSON ìƒì„±
      - name: Create Firebase Service Account Key
        run: |
          printf '%s' "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebaseServiceAccountKey.json


      # ğŸ”¥ DEBUG: ìƒì„±ëœ JSON íŒŒì¼ ë‚´ìš© ì¶œë ¥ (ë‚˜ì¤‘ì— ì‚­ì œí•  ê²ƒ)
     # - name: Show firebaseServiceAccountKey.json (REMOVE AFTER DEBUGGING)
      #  run: |
       #   echo "ğŸ”¥ FIREBASE SERVICE ACCOUNT JSON CONTENT ğŸ”¥"
        #  cat firebaseServiceAccountKey.json

      # JSON í˜•ì‹ ê²€ì¦
      - name: Validate JSON Format
        run: |
          cat firebaseServiceAccountKey.json | jq .

      # JSON í•„ë“œ ê²€ì¦ (client_email, private_key í•„ìˆ˜ í™•ì¸)
      - name: Verify Service Account Fields
        run: |
          echo "ğŸ” Checking JSON fields..."
          CLIENT_EMAIL=$(jq -r '.client_email' firebaseServiceAccountKey.json)
          PRIVATE_KEY=$(jq -r '.private_key' firebaseServiceAccountKey.json)

          if [[ -z "$CLIENT_EMAIL" || -z "$PRIVATE_KEY" ]]; then
            echo "âŒ Error: Missing required fields in firebaseServiceAccountKey.json!"
            exit 1
          else
            echo "âœ… Service account key looks valid."
          fi

      - name: Install Firebase CLI
        run: |
          npm install -g firebase-tools

      - name: Verify Firebase CLI Installation
        run: |
          firebase --version

      # ğŸ”¥ DEBUG: Firebase ì¸ì¦ í…ŒìŠ¤íŠ¸ (ë°°í¬ ì „ì— Firebase CLIê°€ ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ í™•ì¸)
      #- name: Check Firebase Authentication (REMOVE AFTER DEBUGGING)
        # run: |
          #  firebase list --json

      # Firebase CLI ì„¤ì¹˜ í™•ì¸
      - name: Verify Firebase CLI Installation
        run: |
          npm install -g firebase-tools@13.29.3
          firebase --version || echo "âŒ Firebase CLI installation failed!!"

      # Firebase Hosting ë°°í¬
      - name: Deploy to Firebase Hosting
        run: |
          firebase deploy --only hosting --project realtime-signlang-app --debug
        env:
          GOOGLE_APPLICATION_CREDENTIALS: firebaseServiceAccountKey.json
